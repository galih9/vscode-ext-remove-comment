<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="img-src https: data:; style-src 'unsafe-inline' ${cspSource}; script-src 'nonce-${nonce}';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="${styleResetUri}" rel="stylesheet">
  <link href="${styleVSCodeUri}" rel="stylesheet">
  <link href="${styleMainUri}" rel="stylesheet">
  <style>
    body {
      font-family: var(--vscode-font-family, 'Segoe UI', Arial, sans-serif);
      background: var(--vscode-sideBar-background, #1e1e1e);
      color: var(--vscode-sideBar-foreground, #d4d4d4);
    }
    .tstool-container {
      max-width: 400px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .tstool-textarea {
      width: 100%;
      min-height: 100px;
      margin-bottom: 12px;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border, #333);
      background: var(--vscode-input-background, #252526);
      color: var(--vscode-input-foreground, #d4d4d4);
      font-family: var(--vscode-editor-font-family, 'Fira Mono', monospace);
      font-size: 14px;
      padding: 8px;
      resize: vertical;
      box-sizing: border-box;
    }
    .tstool-label {
      margin: 8px 0 4px 0;
      font-weight: bold;
      display: block;
    }
    .tstool-btn {
      background: var(--vscode-button-background, #0e639c);
      color: var(--vscode-button-foreground, #fff);
      border: none;
      border-radius: 4px;
      padding: 6px 16px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .tstool-btn:active {
      background: var(--vscode-button-hoverBackground, #1177bb);
    }
    .tstool-error {
      color: var(--vscode-editorError-foreground, #f14c4c);
      font-size: 13px;
      margin: 4px 0 0 0;
      min-height: 18px;
    }
  </style>
  <script nonce="${nonce}">
    function toPascalCase(str) {
      return str.replace(/(^\w|_\w)/g, s => s.replace('_', '').toUpperCase());
    }

    function jsonToTsInterface(obj, rootName = "Root") {
      const seen = new Map();
      const interfaces = [];

      function getType(val, nameHint) {
        if (val === null) return "any";
        if (Array.isArray(val)) {
          if (val.length === 0) return "any[]";
          // Use first element for type inference
          return getType(val[0], nameHint) + "[]";
        }
        if (typeof val === "object") {
          return parseObject(val, nameHint);
        }
        if (typeof val === "number") return "number";
        if (typeof val === "boolean") return "boolean";
        if (typeof val === "string") return "string";
        return "any";
      }

      function parseObject(obj, nameHint) {
        // Generate interface name
        let ifaceName = toPascalCase(nameHint || "Anon");
        // Avoid duplicate interfaces for the same structure
        const sig = JSON.stringify(Object.keys(obj).sort().map(k => [k, typeof obj[k]]));
        if (seen.has(sig)) return seen.get(sig);

        // If root, use rootName
        if (nameHint === "__ROOT__") ifaceName = rootName;

        let fields = "";
        for (const key in obj) {
          const val = obj[key];
          let fieldType;
          if (typeof val === "object" && val !== null) {
            if (Array.isArray(val)) {
              if (val.length > 0 && typeof val[0] === "object" && val[0] !== null) {
                // Array of objects: generate interface for items
                const childName = toPascalCase(key);
                fieldType = getType(val, childName);
              } else {
                fieldType = getType(val, key);
              }
            } else {
              // Nested object: generate interface
              const childName = toPascalCase(key);
              fieldType = getType(val, childName);
            }
          } else {
            fieldType = getType(val, key);
          }
          fields += `  ${key}: ${fieldType};\n`;
        }
        const iface = `export interface ${ifaceName} {\n${fields}}`;
        interfaces.push(iface);
        seen.set(sig, ifaceName);
        return ifaceName;
      }

      let output = "";
      if (Array.isArray(obj)) {
        // Root is array
        const itemName = rootName + "2";
        const itemType = getType(obj[0], itemName);
        output += `export type ${rootName} = ${itemType}[]\n\n`;
        // Parse the item to generate interfaces
        getType(obj[0], itemName);
      } else if (typeof obj === "object" && obj !== null) {
        // Root is object
        getType(obj, "__ROOT__");
      }
      // Remove duplicates and preserve order
      const unique = Array.from(new Set(interfaces.reverse())).reverse();
      output += unique.join("\n\n");
      return output;
    }

    window.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('json-input');
      const output = document.getElementById('ts-output');
      const error = document.getElementById('json-error');
      const copyBtn = document.getElementById('copy-btn');

      input.addEventListener('input', () => {
        let val = input.value.trim();
        if (!val) {
          output.value = "";
          error.textContent = "";
          return;
        }
        try {
          const obj = JSON.parse(val);
          const iface = jsonToTsInterface(obj);
          output.value = iface;
          error.textContent = "";
        } catch (e) {
          output.value = "";
          error.textContent = "Invalid JSON";
        }
      });

      copyBtn.addEventListener('click', () => {
        output.select();
        document.execCommand('copy');
        copyBtn.textContent = "Copied!";
        setTimeout(() => copyBtn.textContent = "Copy to Clipboard", 1200);
      });
    });
  </script>
</head>
<body>
  <div class="tstool-container">
    <h2>üìù TsTool</h2>
    <p>Convert Json to Interface</p>
    <label class="tstool-label" for="json-input">JSON Input</label>
    <textarea id="json-input" class="tstool-textarea" placeholder='Paste your JSON here'></textarea>
    <div id="json-error" class="tstool-error"></div>
    <label class="tstool-label" for="ts-output">TypeScript Interface Output</label>
    <textarea id="ts-output" class="tstool-textarea" readonly placeholder="Interface will appear here"></textarea>
    <button id="copy-btn" class="tstool-btn" type="button">Copy to Clipboard</button>
  </div>
</body>
</html>
